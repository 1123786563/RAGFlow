# 权限管理系统扩展设计方案

## 1. 现有系统分析

### 1.1 现有数据库模型
- **User**：用户基本信息，包含`is_superuser`字段
- **Tenant**：租户信息
- **UserTenant**：用户与租户的关系，包含`role`字段（OWNER或NORMAL）
- **Knowledgebase**：知识库，包含`permission`字段（me或team）

### 1.2 现有权限系统
- 非常简单，只有两种权限级别：me（个人）和team（团队）
- 没有完整的角色管理、部门管理、菜单管理和审计日志功能
- `admin/server/roles.py`中的`RoleMgr`类只是空实现

## 2. 扩展方案设计

### 2.1 数据库模型扩展

#### 2.1.1 部门管理
```python
class Department(DataBaseModel):
    id = CharField(max_length=32, primary_key=True)
    name = CharField(max_length=100, null=False, help_text="部门名称", index=True)
    parent_id = CharField(max_length=32, null=True, help_text="父部门ID", index=True)
    description = TextField(null=True, help_text="部门描述")
    tenant_id = CharField(max_length=32, null=False, help_text="租户ID", index=True)
    status = CharField(max_length=1, null=True, help_text="状态(0: 无效, 1: 有效)", default="1", index=True)
    
    class Meta:
        db_table = "department"
```

#### 2.1.2 角色管理
```python
class Role(DataBaseModel):
    id = CharField(max_length=32, primary_key=True)
    name = CharField(max_length=100, null=False, help_text="角色名称", index=True)
    description = TextField(null=True, help_text="角色描述")
    tenant_id = CharField(max_length=32, null=False, help_text="租户ID", index=True)
    status = CharField(max_length=1, null=True, help_text="状态(0: 无效, 1: 有效)", default="1", index=True)
    is_system = BooleanField(null=True, help_text="是否系统角色", default=False, index=True)
    
    class Meta:
        db_table = "role"
```

#### 2.1.3 用户-角色关联
```python
class UserRole(DataBaseModel):
    id = CharField(max_length=32, primary_key=True)
    user_id = CharField(max_length=32, null=False, help_text="用户ID", index=True)
    role_id = CharField(max_length=32, null=False, help_text="角色ID", index=True)
    tenant_id = CharField(max_length=32, null=False, help_text="租户ID", index=True)
    status = CharField(max_length=1, null=True, help_text="状态(0: 无效, 1: 有效)", default="1", index=True)
    
    class Meta:
        db_table = "user_role"
```

#### 2.1.4 菜单管理
```python
class Menu(DataBaseModel):
    id = CharField(max_length=32, primary_key=True)
    name = CharField(max_length=100, null=False, help_text="菜单名称", index=True)
    parent_id = CharField(max_length=32, null=True, help_text="父菜单ID", index=True)
    path = CharField(max_length=255, null=True, help_text="菜单路径")
    component = CharField(max_length=255, null=True, help_text="组件路径")
    icon = CharField(max_length=50, null=True, help_text="菜单图标")
    order_num = IntegerField(default=0, help_text="排序号")
    type = CharField(max_length=10, null=False, help_text="菜单类型(menu: 菜单, button: 按钮)", index=True)
    permission = CharField(max_length=100, null=True, help_text="权限标识")
    status = CharField(max_length=1, null=True, help_text="状态(0: 无效, 1: 有效)", default="1", index=True)
    
    class Meta:
        db_table = "menu"
```

#### 2.1.5 角色-菜单关联
```python
class RoleMenu(DataBaseModel):
    id = CharField(max_length=32, primary_key=True)
    role_id = CharField(max_length=32, null=False, help_text="角色ID", index=True)
    menu_id = CharField(max_length=32, null=False, help_text="菜单ID", index=True)
    
    class Meta:
        db_table = "role_menu"
```

#### 2.1.6 审计日志
```python
class AuditLog(DataBaseModel):
    id = CharField(max_length=32, primary_key=True)
    user_id = CharField(max_length=32, null=False, help_text="操作用户ID", index=True)
    username = CharField(max_length=100, null=False, help_text="操作用户名")
    operation = CharField(max_length=100, null=False, help_text="操作类型")
    module = CharField(max_length=50, null=False, help_text="操作模块")
    ip = CharField(max_length=50, null=True, help_text="操作IP")
    url = CharField(max_length=255, null=True, help_text="请求URL")
    method = CharField(max_length=10, null=True, help_text="请求方法")
    params = TextField(null=True, help_text="请求参数")
    result = TextField(null=True, help_text="操作结果")
    status = CharField(max_length=1, null=True, help_text="状态(0: 失败, 1: 成功)", default="1", index=True)
    error_msg = TextField(null=True, help_text="错误信息")
    operation_time = DateTimeField(null=True, help_text="操作时间", index=True)
    tenant_id = CharField(max_length=32, null=False, help_text="租户ID", index=True)
    
    class Meta:
        db_table = "audit_log"
```

#### 2.1.7 知识库权限扩展
```python
class KnowledgebasePermission(DataBaseModel):
    id = CharField(max_length=32, primary_key=True)
    kb_id = CharField(max_length=32, null=False, help_text="知识库ID", index=True)
    user_id = CharField(max_length=32, null=True, help_text="用户ID", index=True)
    role_id = CharField(max_length=32, null=True, help_text="角色ID", index=True)
    dept_id = CharField(max_length=32, null=True, help_text="部门ID", index=True)
    permission_type = CharField(max_length=10, null=False, help_text="权限类型(read: 只读, write: 读写, manage: 管理)")
    tenant_id = CharField(max_length=32, null=False, help_text="租户ID", index=True)
    
    class Meta:
        db_table = "knowledgebase_permission"
```

### 2.2 API扩展

#### 2.2.1 部门管理API
- `POST /api/v1/departments` - 创建部门
- `GET /api/v1/departments` - 获取部门列表
- `GET /api/v1/departments/{id}` - 获取部门详情
- `PUT /api/v1/departments/{id}` - 更新部门
- `DELETE /api/v1/departments/{id}` - 删除部门

#### 2.2.2 角色管理API
- `POST /api/v1/roles` - 创建角色
- `GET /api/v1/roles` - 获取角色列表
- `GET /api/v1/roles/{id}` - 获取角色详情
- `PUT /api/v1/roles/{id}` - 更新角色
- `DELETE /api/v1/roles/{id}` - 删除角色
- `POST /api/v1/roles/{id}/permissions` - 分配角色权限
- `GET /api/v1/roles/{id}/permissions` - 获取角色权限

#### 2.2.3 菜单管理API
- `POST /api/v1/menus` - 创建菜单
- `GET /api/v1/menus` - 获取菜单列表
- `GET /api/v1/menus/{id}` - 获取菜单详情
- `PUT /api/v1/menus/{id}` - 更新菜单
- `DELETE /api/v1/menus/{id}` - 删除菜单
- `GET /api/v1/menus/tree` - 获取菜单树

#### 2.2.4 审计日志API
- `GET /api/v1/audit-logs` - 获取审计日志列表
- `GET /api/v1/audit-logs/{id}` - 获取审计日志详情
- `POST /api/v1/audit-logs/export` - 导出审计日志

#### 2.2.5 知识库权限API
- `POST /api/v1/kbs/{kb_id}/permissions` - 分配知识库权限
- `GET /api/v1/kbs/{kb_id}/permissions` - 获取知识库权限列表
- `DELETE /api/v1/kbs/{kb_id}/permissions/{id}` - 删除知识库权限

### 2.3 前端实现方案

#### 2.3.1 权限管理页面
- **部门管理**：树形结构展示，支持增删改查
- **角色管理**：角色列表，支持创建、编辑、删除和权限分配
- **菜单管理**：树形结构展示，支持增删改查
- **审计日志**：表格展示，支持筛选、搜索和导出

#### 2.3.2 权限控制组件
- **PermissionGuard**：路由级权限控制组件
- **PermissionButton**：按钮级权限控制组件
- **PermissionMenu**：菜单级权限控制组件

#### 2.3.3 状态管理
- 扩展现有状态管理，添加权限相关状态
- 实现权限动态加载和缓存

### 2.4 权限控制流程

1. **用户登录**：验证用户身份，获取用户角色
2. **权限加载**：根据用户角色加载菜单权限和操作权限
3. **路由控制**：根据权限动态生成路由
4. **页面控制**：根据权限控制页面元素显示
5. **API控制**：后端根据用户权限验证API访问
6. **操作审计**：记录用户所有操作日志

## 3. 实现步骤

### 3.1 数据库层实现
1. 添加新的数据库模型
2. 更新数据库迁移脚本
3. 初始化默认数据

### 3.2 后端API实现
1. 实现部门管理API
2. 实现角色管理API
3. 实现菜单管理API
4. 实现审计日志API
5. 实现知识库权限API
6. 更新现有API的权限验证逻辑

### 3.3 前端实现
1. 实现权限管理页面
2. 实现权限控制组件
3. 更新路由和菜单逻辑
4. 添加权限状态管理

### 3.4 测试和优化
1. 单元测试
2. 集成测试
3. 性能优化
4. 安全审计

## 4. 预期效果

1. **完整的权限体系**：实现用户-角色-权限的三级权限控制
2. **灵活的权限配置**：支持细粒度的权限分配
3. **完善的审计机制**：记录所有用户操作
4. **良好的用户体验**：直观的权限管理界面
5. **高扩展性**：支持未来功能扩展

## 5. 技术栈

- **后端**：Python、Quart、Peewee ORM
- **前端**：React、TypeScript、Ant Design
- **数据库**：MySQL/PostgreSQL

## 6. 风险评估

1. **兼容性风险**：需要确保与现有系统兼容
2. **性能风险**：权限验证可能影响系统性能
3. **安全风险**：权限系统本身需要严格的安全控制
4. **复杂度风险**：权限系统增加了系统复杂度

## 7. 应对措施

1. **兼容性处理**：采用增量式扩展，保持向后兼容
2. **性能优化**：实现权限缓存机制，减少数据库查询
3. **安全加固**：严格的权限验证，防止权限绕过
4. **简化设计**：保持权限模型简洁，避免过度设计

## 8. 后续扩展

1. **数据权限**：实现基于数据级别的权限控制
2. **审批流程**：添加权限审批机制
3. **权限分析**：实现权限使用情况分析
4. **多租户增强**：增强多租户权限隔离

## 9. 结论

本设计方案通过扩展现有系统，实现了完整的权限管理体系，包括用户管理、部门管理、角色管理、菜单管理、审计日志和知识库权限。该方案具有良好的扩展性和灵活性，能够满足企业级应用的权限管理需求。